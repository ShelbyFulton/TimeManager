<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Time Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src='static/fullcalendar/dist/index.global.js'></script>
  <script src='static/app.js'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <link href='static/style.css' rel='stylesheet' />
  <script>

    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        // Calendar configuration options
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        initialDate: '2024-04-02',
        navLinks: true,
        selectable: true,
        selectMirror: true,
        eventClick: function (arg) {
          if (confirm('Are you sure you want to delete this event?')) {
            // Send an AJAX request to delete the event from the database
            $.ajax({
              type: 'POST',
              url: '/delete-event',
              contentType: 'application/json',
              data: JSON.stringify({ event_id: arg.event._def.publicId }), // Pass the event ID to the server
              success: function (response) {
                console.log(response); // Log success message
                arg.event.remove(); // Remove the event from the calendar UI
                refreshCalendar(); // Refresh the calendar after deleting the event
              },
              error: function (xhr, status, error) {
                console.error(error); // Log error message
                // Handle errors and provide feedback to the user
              }
            });
          }
        },
        editable: true,
        dayMaxEvents: true,
        select: function (arg) {
          var title = prompt('Event Title:');
          if (title) {
            let requestData = {
              type: 'POST',
              url: '/add-event',
              contentType: 'application/json',
              data: JSON.stringify({
                username: '{{username}}',
                title: title,
                start: arg.start.toISOString(),
                end: arg.end.toISOString(),
                allDay: arg.allDay
              }),
              success: function (response) {
                if (response.id) {
                  calendar.addEvent({
                    title: title,
                    start: arg.start,
                    end: arg.end,
                    allDay: arg.allDay,
                    id: response.id
                  });
                  refreshCalendar(); // Refresh the calendar after adding the event
                }

              },
              error: function (xhr, status, error) {
                alert('There was an error processing your request. Please try again.');
                console.error(error);
              }
            };
            $.ajax(requestData);
          }
          calendar.unselect();
        },
        eventDrop: function (arg) {
          // When an event is dropped/moved, send an AJAX request to update the event on the server
          $.ajax({
            type: 'POST',
            url: '/update-event',
            contentType: 'application/json',
            data: JSON.stringify({
              event_id: arg.event._def.publicId,
              start: arg.event.start.toISOString(),
              end: arg.event.end ? arg.event.end.toISOString() : null // Check if the event has an end time
            }),
            success: function (response) {
              console.log(response); // Log success message
            },
            error: function (xhr, status, error) {
              console.error(error); // Log error message
              // Handle errors and provide feedback to the user
            }
          });
        },
        eventResize: function (arg) {
          // When an event is resized, send an AJAX request to update the event duration on the server
          $.ajax({
            type: 'POST',
            url: '/update-event',
            contentType: 'application/json',
            data: JSON.stringify({
              event_id: arg.event._def.publicId,
              start: arg.event.start.toISOString(),
              end: arg.event.end ? arg.event.end.toISOString() : null // Check if the event has an end time
            }),
            success: function (response) {
              console.log(response); // Log success message
            },
            error: function (xhr, status, error) {
              console.error(error); // Log error message
              // Handle errors and provide feedback to the user
            }
          });
        }
      });

      calendar.render();

      // Get events from the server
      $.ajax({
        type: 'GET',
        url: '/get-events',
        success: function (response) {
          // Add events to the calendar
          calendar.addEventSource(response);
        },
        error: function (xhr, status, error) {
          console.error(error);
          // Handle errors and provide feedback to the user
        }
      });
      // Event listener for the "Add Task" button click
      document.getElementById('addTaskButton').addEventListener('click', addTask);

      // Refresh the calendar every 5 seconds
      setInterval(refreshCalendar, 5000);

      // Define refreshCalendar function
      function refreshCalendar() {
        // Get events from the server
        $.ajax({
          type: 'GET',
          url: '/get-events',
          success: function (events) {
            // Clear the calendar
            calendar.removeAllEvents();
            // Add events to the calendar
            calendar.addEventSource(events);
            calendar.render();
          },
          error: function (xhr, status, error) {
            console.error(error);
            // Handle errors and provide feedback to the user
          }
        });
      }
    });





    function addTask() {
      let title = $('#taskName').val();
      let duration = Math.round(parseFloat($('#duration').val()));
      let startDate = $('#startDate').val();
      let startTime = $('#startTime').val();
      let dueDate = $('#dueDate').val();
      let dueTime = $('#dueTime').val();

      let startDateTime = new Date(startDate + ' ' + startTime); // Combine start date and time
      let endDateTime = new Date(dueDate + ' ' + dueTime); // Combine due date and time

      // Send task details to the server
      $.ajax({
        type: 'POST',
        url: '/add-task',
        contentType: 'application/json',
        data: JSON.stringify({
          username: '{{username}}',
          title: title,
          start: startDateTime,
          end: endDateTime,
          length: duration  // Include task-specific field
        }),
        success: function (response) {
          // Handle success response if needed
          console.log('Task added successfully:', response);
          // Refresh the calendar or any other action you need
          // Update the task list with the newly added task
          $('#taskList').append('<li>' + title + '<a href="#" class="delete-task" data-id="' + response.id + '">‚ùå</a></li>');
        },
        error: function (xhr, status, error) {
          // Handle error response if needed
          console.error('Error adding task:', error);
        }
      });

      // Clear the input fields
      $('#taskName').val('');
      $('#duration').val('');
      $('#startDate').val('');
      $('#startTime').val('');
      $('#dueDate').val('');
      $('#dueTime').val('');
    }

    $(document).on('click', '.delete-task', function () {
      var taskId = $(this).data('id');
      console.log('Deleting task with ID:', taskId);
      var listItem = $(this).closest('li'); // Get the parent <li> element

      // Send an AJAX request to delete the task from the server
      $.ajax({
        type: 'POST',
        url: '/delete-task',
        contentType: 'application/json',
        data: JSON.stringify({ task_id: taskId }), // Pass the task ID to the server
        success: function (response) {
          console.log(response); // Log success message
          // Remove the task from the task list
          listItem.remove(); // Remove the parent <li> element
        },
        error: function (xhr, status, error) {
          console.error(error); // Log error message
          // Handle errors and provide feedback to the user
        }
      });
    });


    // Define getRandomColor function
    function getRandomColor() {
      var minBrightness = 128; // Minimum brightness threshold

      // Generate random values for red, green, and blue components
      var r = Math.floor(Math.random() * 256);
      var g = Math.floor(Math.random() * 256);
      var b = Math.floor(Math.random() * 256);

      // Calculate the brightness of the color using the YIQ formula
      var brightness = (r * 299 + g * 587 + b * 114) / 1000;

      // If the brightness is below the threshold, adjust the color
      if (brightness < minBrightness) {
        // Increase brightness by adding a fixed value to each component
        var brightnessDifference = minBrightness - brightness;
        var adjustmentFactor = brightnessDifference / brightness;
        r = Math.min(255, Math.floor(r + adjustmentFactor * r));
        g = Math.min(255, Math.floor(g + adjustmentFactor * g));
        b = Math.min(255, Math.floor(b + adjustmentFactor * b));
      }

      // Convert RGB components to hexadecimal string representation
      var hexColor = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

      return hexColor;
    }

    document.addEventListener("DOMContentLoaded", function () {
      var phrases = [
        "You got this",
        "You're awesome",
        "Believe in yourself",
        "Stay positive",
        "Keep going",
        "Dream big",
        "Make it happen",
        "You're amazing",
        "You can do it",
        "Never give up",
        "Almost Friday",
        "Work hard play hard",
        "Grades are a social construct",
        "We out here",
        "So back",
        "Academic weapon",
        "Just rip it",
        "F it we ball",
        "Here we go",
        "You're so up right now",
        "Keep going!",
        "Don't forget to rest!"
      ];

      var index = 0;
      var dynamicText = document.getElementById("dynamicText");

      function updateText() {
        var phrase = phrases[index];
        var words = phrase.split(' '); // Split the phrase into words

        dynamicText.textContent = ''; // Clear the text content initially

        // Apply the random color to the text element
        dynamicText.style.color = getRandomColor();

        // Display each word sequentially with a delay
        words.forEach(function (word, wordIndex) {
          setTimeout(function () {
            dynamicText.textContent += word + ' '; // Append the word with a space
            // If it's the last word, append a newline character
            if (wordIndex === words.length - 1) {
              dynamicText.textContent += '\n';
            }
          }, wordIndex * 500); // Delay each word by 500 milliseconds
        });

        index = (index + 1) % phrases.length;
      }

      // Initial text update
      updateText();

      // Update text every 3 seconds
      setInterval(updateText, 3000);
    });

    function logout() {
      // Call the logout route when the button is clicked
      $.ajax({
        type: 'GET',
        url: '/logoutapp',
        success: function (response) {
          console.log(response); // success message
          window.location.href = '/landing'; // Redirect to the landing page
        },
        error: function (xhr, status, error) {
          console.error(error); // Log error message
        }
      });

    }


  </script>
</head>

<body>
  <div id='calendar'></div>

  <div class="sidebarleft">
    <h2>Add Task</h2>
    <h2> Hello {{username}} </h2>
    <label for="taskName">Task Name:</label>
    <input class="input" type="text" id="taskName" name="taskName" placeholder="Enter task name">

    <label for="duration">Duration (hours):</label>
    <input class="input" type="number" id="duration" name="duration" placeholder="Enter duration">
    <br>

    <label for="startDate">When to start:</label>
    <input class="input" type="date" id="startDate" name="startDate">
    <input class="input" type="time" id="startTime" name="startTime">
    <br>

    <label for="dueDate">When Due:</label>
    <input class="input" type="date" id="dueDate" name="dueDate">
    <input class="input" type="time" id="dueTime" name="dueTime">

    <button id="addTaskButton">Add Task</button> <!-- Removed onclick attribute -->

    <h2>Tasks</h2>
    <ul id="taskList"></ul>
  </div>
  <div class="sidebarright">
    <h2 id="dynamicText"> Loading...</h2>
  </div>
  <button onclick="logout()" id="logoutButton" style="position: absolute; top: 10px; right: 10px;">Logout</button>
</body>

</html>