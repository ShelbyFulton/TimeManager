<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <script src='static/fullcalendar/dist/index.global.js'></script>
  <script src='static/app.js'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  
  <link href='static/style.css' rel='stylesheet' />
  <script>
    
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        // Calendar configuration options
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        initialDate: '2024-04-02',
        navLinks: true,
        selectable: true,
        selectMirror: true,
        eventClick: function (arg) {
          if (confirm('Are you sure you want to delete this event?')) {
            // Send an AJAX request to delete the event from the database
            $.ajax({
              type: 'POST',
              url: '/delete-event',
              contentType: 'application/json',
              data: JSON.stringify({ event_id: arg.event._def.publicId }), // Pass the event ID to the server
              success: function (response) {
                console.log(response); // Log success message
                arg.event.remove(); // Remove the event from the calendar UI
              },
              error: function (xhr, status, error) {
                console.error(error); // Log error message
                // Handle errors and provide feedback to the user
              }
            });
          }
        },
        editable: true,
        dayMaxEvents: true,
        select: function (arg) {
          var title = prompt('Event Title:');
          if (title) {
            let requestData = {
              type: 'POST',
              url: '/add-event',
              contentType: 'application/json',
              data: JSON.stringify({
                username: '{{username}}',
                title: title,
                start: arg.start.toISOString(),
                end: arg.end.toISOString(),
                allDay: arg.allDay
              }),
              success: function (response) {
                if (response.id) {
                  calendar.addEvent({
                    title: title,
                    start: arg.start,
                    end: arg.end,
                    allDay: arg.allDay,
                    id: response.id
                  });
                }
                
              },
              error: function (xhr, status, error) {
                alert('There was an error processing your request. Please try again.');
                console.error(error);
              }
            };
            $.ajax(requestData);
          }
          calendar.unselect();
        }
      });

      calendar.render();

      // Get events from the server
      $.ajax({
        type: 'GET',
        url: '/get-events',
        success: function (response) {
          // Add events to the calendar
          calendar.addEventSource(response);
        },
        error: function (xhr, status, error) {
          console.error(error);
          // Handle errors and provide feedback to the user
        }
      });
      // Event listener for the "Add Task" button click
      document.getElementById('addTaskButton').addEventListener('click', addTask);
    });

    $.ajax({
      type: 'GET',
      url: '/get-tasks',
      success: function (response) {
        // Add tasks to the list
        response.forEach(function (task) {
          console.log(task);
          $('#taskList').append('<li>' + task.title + '<a href="#" class="delete-task" data-id="' + task.id + '">❌</a></li>');
        });
        
        // Attach click event handler for delete task links
        $('#taskList').on('click', 'a.delete-task', function(event) {
          event.preventDefault();
          var taskId = $(this).data('id'); // Use the data-id attribute of the clicked element
          console.log(taskId);
          $.ajax({
            type: 'GET',
            url: '/delete-task?id=' + taskId,
            success: function(response) {
              // Remove the task from the list if deletion is successful
              $(event.target).closest('li').remove();
              console.log(response.message); // Display success message
            },
            error: function(xhr, status, error) {
              console.log(xhr.responseText); // Display error message
            }
          });
        });
      },
      error: function (xhr, status, error) {
        console.error(error);
        // Handle errors and provide feedback to the user
      }
    });
    

    function addTask() {
      let title = $('#taskName').val();
      let duration = Math.round(parseFloat($('#duration').val()));
      let startDate = $('#startDate').val();
      let startTime = $('#startTime').val();
      let dueDate = $('#dueDate').val();
      let dueTime = $('#dueTime').val();

      let startDateTime = new Date(startDate + ' ' + startTime); // Combine start date and time
      let endDateTime = new Date(dueDate + ' ' + dueTime); // Combine due date and time

      // Send task details to the server
      $.ajax({
        type: 'POST',
        url: '/add-task',
        contentType: 'application/json',
        data: JSON.stringify({
            username: '{{username}}',
            title: title,
            start: startDateTime,
            end: endDateTime,
            length: duration  // Include task-specific field
        }),
        success: function (response) {
            // Handle success response if needed
            console.log('Task added successfully:', response);
            // Refresh the calendar or any other action you need
            // Get events from the server
            $.ajax({
                type: 'GET',
                url: '/get-events',
                success: function (events) {
                    // Clear the task list
                    $('#taskList').empty();
                    // Add events to the calendar
                    calendar.addEventSource(events);
                    calendar.render();
                    // Add tasks to the task list
                    events.forEach(function(event) {
                      console.log(event);
                        $('#taskList').append('<li>' + event.title + '<a href="#" class="delete-task" data-id="' + event.id + '">❌</a></li>');
                    });
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    // Handle errors and provide feedback to the user
                }
            });
        },
        
        error: function (xhr, status, error) {
            // Handle error response if needed
            console.error('Error adding task:', error);
        }
    });


      

      // Clear the input fields
      // $('#taskName').val('');
      // $('#duration').val('');
      // $('#startDate').val('');
      // $('#startTime').val('');
      // $('#dueDate').val('');
      // $('#dueTime').val('');
    
    }

    // Define getRandomColor function
    function getRandomColor() {
      var minBrightness = 128; // Minimum brightness threshold

      // Generate random values for red, green, and blue components
      var r = Math.floor(Math.random() * 256);
      var g = Math.floor(Math.random() * 256);
      var b = Math.floor(Math.random() * 256);

      // Calculate the brightness of the color using the YIQ formula
      var brightness = (r * 299 + g * 587 + b * 114) / 1000;

      // If the brightness is below the threshold, adjust the color
      if (brightness < minBrightness) {
        // Increase brightness by adding a fixed value to each component
        var brightnessDifference = minBrightness - brightness;
        var adjustmentFactor = brightnessDifference / brightness;
        r = Math.min(255, Math.floor(r + adjustmentFactor * r));
        g = Math.min(255, Math.floor(g + adjustmentFactor * g));
        b = Math.min(255, Math.floor(b + adjustmentFactor * b));
      }

      // Convert RGB components to hexadecimal string representation
      var hexColor = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

      return hexColor;
    }

    document.addEventListener("DOMContentLoaded", function() {
    var phrases = [
        "You got this",
        "You're awesome",
        "Believe in yourself",
        "Stay positive",
        "Keep going",
        "Dream big",
        "Make it happen",
        "You're amazing",
        "You can do it",
        "Never give up",
        "Almost Friday",
        "Work hard play hard",
        "Grades are a social construct",
        "We out here",
        "So back",
        "Academic weapon",
        "Just rip it",
        "F it we ball",
        "Here we go",
        "You're so up right now",
        "Keep going!",
        "Don't forget to rest!"
    ];

    var index = 0;
    var dynamicText = document.getElementById("dynamicText");

    function updateText() {
      var phrase = phrases[index];
      var words = phrase.split(' '); // Split the phrase into words

      dynamicText.textContent = ''; // Clear the text content initially

      // Apply the random color to the text element
      dynamicText.style.color = getRandomColor();

      // Display each word sequentially with a delay
      words.forEach(function(word, wordIndex) {
          setTimeout(function() {
              dynamicText.textContent += word + ' '; // Append the word with a space
              // If it's the last word, append a newline character
              if (wordIndex === words.length - 1) {
                  dynamicText.textContent += '\n';
              }
          }, wordIndex * 500); // Delay each word by 500 milliseconds
      });

      index = (index + 1) % phrases.length;
    }

    // Initial text update
    updateText();

    // Update text every 3 seconds
    setInterval(updateText, 3000);
    });

    document.getElementById('saveButton').addEventListener('click', function() {
    saveEvents();
    saveTasks();
});

function saveEvents() {
    // Get all events from the FullCalendar instance
    var events = calendar.getEvents();

    // Send AJAX request to save each event to the server
    events.forEach(function(event) {
        $.ajax({
            type: 'POST',
            url: '/add-event',
            contentType: 'application/json',
            data: JSON.stringify({
                username: '{{username}}',
                title: event.title,
                start: event.start.toISOString(),
                end: event.end.toISOString(),
                allDay: event.allDay
            }),
            success: function(response) {
                console.log('Event saved successfully:', response);
            },
            error: function(xhr, status, error) {
                console.error('Error saving event:', error);
            }
        });
    });
}

    function logout() {
      // Call the logout route when the button is clicked
      $.ajax({
        type: 'GET',
        url: '/logoutapp',
        success: function (response) {
          console.log(response); // success message
          window.location.href = '/landing'; // Redirect to the landing page
        },
        error: function (xhr, status, error) {
          console.error(error); // Log error message
        }
      });

    }

  </script>
</head>

<body>
  <div id='calendar'></div>
  
  <div class="sidebarleft">
    <h2>Add Task</h2>
    <h2> Hello {{username}} </h2>
    <label for="taskName">Task Name:</label>
    <input class="input" type="text" id="taskName" name="taskName" placeholder="Enter task name">

    <label for="duration">Duration (hours):</label>
    <input class="input" type="number" id="duration" name="duration" placeholder="Enter duration">
    <br>

    <label for="startDate">When to start:</label>
    <input class="input" type="date" id="startDate" name="startDate"> 
    <input class="input" type="time" id="startTime" name="startTime">
    <br>
    
    <label for="dueDate">When Due:</label>
    <input class="input" type="date" id="dueDate" name="dueDate"> 
    <input class="input" type="time" id="dueTime" name="dueTime">

    <button id="addTaskButton">Add Task</button> <!-- Removed onclick attribute -->

    <h2>Tasks</h2>
    <ul id="taskList"></ul>
</div>
  <div class="sidebarright">
    <h2 id="dynamicText"> Loading...</h2>
  </div>
  <button onclick="logout()" id="logoutButton" style="position: absolute; top: 10px; right: 10px;">Logout</button>
</body>
</html>